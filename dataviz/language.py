import sqlite3, json
import hash_framework as hf
import png


q = "SELECT DISTINCT tag FROM c_md4 WHERE tag LIKE '%r48%';"
print(q)

DOT = "/tmp/language.dot"

db = sqlite3.connect("/home/cipherboy/framework_results_2.db")
curr = db.cursor()
data = curr.execute(q).fetchall()
data = map(lambda y: y[0], data)

raw_tags = list(map(lambda x: tuple(map(int, x[9:].split("-"))), data))


wangs_base = [
    "................................",
    ".........................*......",
    ".....................*..*.......",
    "......*.........................",
    "................................",
    "..................*.............",
    "..........****..................",
    ".................***............",
    "...............*................",
    "......*..****...................",
    "..*.............................",
    "*...............................",
    "......*..*......................",
    "..**.*..........................",
    "................................",
    ".............*..................",
    "*..*.**.........................",
    "................................",
    "................................",
    "*.*.............................",
    "*.**............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "*...............................",
    "*...............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
]
sasakis_base = [
    "*.............................**",
    "......................*.*.......",
    "....................*...........",
    "..........***...................",
    ".......***............*******...",
    "*..........***..................",
    "*......***............*********.",
    "................................",
    "......*.**......................",
    "***.***............*............",
    "...................*............",
    "...................*............",
    "..**..*.........................",
    "................................",
    "................................",
    "*...............................",
    "...*............................",
    "................................",
    "................................",
    "................................",
    "*...............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "*...............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
]
kasselman_base = [
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "********************************",
    "................................",
    "...*...............*............",
    "...................*...........*",
    "................................",
    "................................",
    "..........................*.....",
    "......*.........................",
    "................................",
    "................................",
    ".................*..............",
    ".........................*......",
    "................................",
    "................................",
    "........*.......................",
    "............*...................",
    "................................",
    "................................",
    "...............................*",
    "...............................*",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
]
dobbertins_base = [
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "********************************",
    "................................",
    "...*...............*............",
    "...................*...........*",
    "................................",
    "................................",
    "..........................*.....",
    "......*.........................",
    "................................",
    "................................",
    ".................*..............",
    ".........................*......",
    "................................",
    "............*...................",
    "........*.......................",
    "............*...................",
    "................................",
    "................................",
    "...............................*",
    "...............................*",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
]
schlaffers_base = [
    "................................",
    ".........................*......",
    ".....................*..*.......",
    "......*.........................",
    "................................",
    "...............****.............",
    "........***..*..................",
    "...................*.*..........",
    ".....**.....*...................",
    "........****....................",
    "..*.............................",
    "*.*............................*",
    "..**..*..*.**...................",
    "................................",
    "................................",
    "............**.*................",
    "*..*..*.........................",
    "................................",
    "................................",
    "*...............................",
    "*..*............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "*...............................",
    "*...............................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
    "................................",
]

bases = {
    "wangs": tuple(wangs_base),
    "sasakis": tuple(sasakis_base),
    "kasselmans": tuple(kasselman_base),
    "dobbertins": tuple(dobbertins_base),
    "schlaffers": tuple(schlaffers_base),
}

f_bases = {}
for k in bases:
    f_bases[k] = hf.attacks.collision.metric.loose.abs_alt(48, bases[k])

indices = {}
for k in f_bases:
    indices[k] = raw_tags.index(f_bases[k])

print(indices)
print(f_bases)

f_graph = {}
for a in range(0, len(raw_tags)):
    f_a = raw_tags[a]
    f_graph[a] = set()
    for b in range(0, len(raw_tags)):
        f_b = raw_tags[b]
        if len(set(f_a).symmetric_difference(set(f_b))) == 1:
            f_graph[a].add(b)


f = open(DOT, "w")
f.write("graph dataviz {\n")
f.write('size="10,10";' + "\n")
f.write("overlap = false;\n")
f.write("splines = true;\n")
f.write(
    'node [\ncolor="#7C2529";\nfontcolor="#7C2529";\n];\nedge [\ncolor="#F1BE48";\n];\n'
)
f.write("\n\n")

for e in f_graph:
    # if e == indices['wangs']:
    #    f.write("v" + str(e) + " [label=\"Wang\"];\n")
    # elif e == indices['schlaffers']:
    #    f.write("v" + str(e) + " [label=\"Schlaffer\"];\n")
    # else:
    f.write("v" + str(e) + ' [label="",shape=circle];\n')

f.write("\n\n")
for u in f_graph:
    for v in f_graph[u]:
        if u < v:
            f.write("v" + str(u) + "--v" + str(v) + ";\n")


f.write("}\n")
f.flush()
f.close()
